"use strict";var FancypageApp=new Marionette.Application;FancypageApp.on("initialize:after",function(){var a=(new FancypageApp.Views.EditorPanel,new FancypageApp.Views.EditorFormView),b=new FancypageApp.Views.PageView;b.bind("update-block",a.updateBlock)}),FancypageApp.module("Api",function(a,b,c,d,e){a.baseUrl="/api/v2",a.getCsrfToken=function(){return e.cookie("csrftoken")},a.reloadPage=function(){e("div[data-behaviours~=loading]").fadeIn(300),setTimeout(function(){window.location.reload()},300)}}),FancypageApp.module("Models",function(a,b,c,d,e){var f=c.sync;c.sync=function(a,c,d){return d.beforeSend=function(a){e.cookie("csrfToken"),a.setRequestHeader("X-CSRFToken",b.Api.getCsrfToken())},f(a,c,d)},a.Container=c.Model.extend({idAttribute:"uuid"}),a.Containers=c.Collection.extend({model:a.Container}),a.ContentBlock=c.Model.extend({idAttribute:"uuid",url:function(){return b.Api.baseUrl+"/block/"+this.id},move:function(){return this.save({},{url:this.url()+"/move"})}}),a.ContentBlocks=c.Collection.extend({model:a.ContentBlock}),a.BlockForm=c.Model.extend({idAttribute:"uuid",defaults:{container:null},url:function(){return b.Api.baseUrl+"/block/"+this.id+"/form"}}),a.AssetInputModel=c.Model.extend({defaults:{id:null,image:null,type:null}}),a.OrderedContainer=c.Model.extend({idAttribute:"uuid",url:function(){return b.Api.baseUrl+"/ordered-container/"+this.id}}),a.OrderedContainers=c.Collection.extend({model:a.OrderedContainer,url:b.Api.baseUrl+"/ordered-containers"}),a.PageLinkForm=c.Model.extend({defaults:{fieldId:null},url:function(){return b.Api.baseUrl+"/pages/select-form?field_id="+this.get("fieldId")}})}),FancypageApp.module("Views",function(a,b,c,d,e,f){a.FroalaEditor=d.View.extend({defaultEditorOptions:{inlineMode:!1,buttons:["bold","italic","createLink","insertOrderedList","insertUnorderedList","html"]},editorOptions:{},initialize:function(a){f.bindAll(this,"updatePreview");var b={contentChangedCallback:this.updatePreview};this.block=a.block,this.textarea=e("textarea",this.$el),f.extend(b,this.editorOptions),this.textarea.editable(b),this.editor=e(".froala-element",this.$el)},updatePreview:function(){var a=e(this.textarea).attr("id").replace("id_",""),b=e("#block-"+this.block.id+"-"+a);e(b).html(this.editor.html())}}),a.TrumbowygEditor=d.View.extend({defaultEditorOptions:{fullscreenable:!1,closable:!1,btns:["bold","italic","|","link","|","unorderedList","orderedList","|","viewHTML"]},editorOptions:{},initialize:function(a){this.editorOptions=f.defaults(this.editorOptions,this.defaultEditorOptions),f.bindAll(this,"updatePreview"),this.block=a.block,this.textarea=e("textarea",this.$el),this.textarea.trumbowyg(this.editorOptions),this.editor=e(".trumbowyg-editor",this.$el),this.editor.on("change",this.updatePreview),this.editor.on("keyup",this.updatePreview),e("button",this.$el).on("click",this.updatePreview)},updatePreview:function(){var a=e(this.textarea).attr("id").replace("id_",""),b=e("#block-"+this.block.id+"-"+a);e(b).html(this.textarea.val())}}),a.addInitializer(function(b){b=b||{};var c=b.editorOptions||{};switch(b.editor||"trumbowyg"){case"custom":a.RichTextEditor=b.editorView.extend({editorOptions:c});break;case"froala":a.RichTextEditor=a.FroalaEditor.extend({editorOptions:c});break;default:case"trumbowyg":a.RichTextEditor=a.TrumbowygEditor.extend({editorOptions:c})}}),a.EditorControls=c.View.extend({el:".fp-editor-controls",events:{"click #editor-close":"closeEditor"},closeEditor:function(){this.trigger("close-editor")}}),a.EditorHandle=c.View.extend({el:"#editor-handle",events:{click:"openPanel"},openPanel:function(){this.trigger("open-panel")},show:function(){this.$el.trigger("show")},hide:function(){this.$el.trigger("hide")}}),a.EditorPanel=c.View.extend({el:"#editor-panel",initialize:function(){f.bindAll(this,"hide"),f.bindAll(this,"show"),this.controls=new a.EditorControls,this.controls.bind("close-editor",this.hide),this.handle=new a.EditorHandle,this.handle.bind("open-panel",this.show),"true"===e.cookie("fpEditorOpened")&&this.show()},show:function(){this.handle.show(),e("body").removeClass("editor-hidden"),e.cookie("fpEditorOpened",!0)},hide:function(){this.handle.hide(),e("body").addClass("editor-hidden"),e.cookie("fpEditorOpened",!1)}}),a.ContentBlockView=c.View.extend({events:{"click >.fp-btn.edit-button":"editBlock","click >.block-move-delete>.fp-btn.move":"moveBlock","click >.block-move-delete>.fp-btn.delete":"deleteBlock",mouseenter:"showButtons",mouseleave:"hideButtons"},initialize:function(){var b=this;f.each(e(">div.fp-tabbable",this.$el),function(c){new a.TabbedBlock({el:c,model:b.model})})},showButtons:function(){this.$el.addClass("block-hover")},hideButtons:function(){this.$el.removeClass("block-hover")},editBlock:function(){this.trigger("update-block","edit",this.model)},moveBlock:function(){this.trigger("update-block","move",this.model)},deleteBlock:function(){this.trigger("update-block","delete",this.model)}}),a.PageView=c.View.extend({el:".editable-page-wrapper",initialize:function(){var c=this;f.bindAll(this,"updateBlock"),this.initializeVideo(),this.initializeSlideShow(),this.sortables=e(".sortable").sortable({containerSelector:".sortable",group:"sortable-containers",nested:!1,handle:".move",itemSelector:".block",placeholder:'<div class="placeholder">Insert here!</div>',onDragStart:this.displayMoveGrid,onDrop:this.saveMovedBlock}),f.each(e(".block",this.$el),function(d){var f=new b.Models.ContentBlock({uuid:e(d).data("block-id"),container:e(d).data("container-id"),languageCode:e(d).attr("lang")}),g=new a.ContentBlockView({model:f,el:d});g.bind("update-block",c.updateBlock)});var d=new a.BlockTypeView;f.each(e(".block-add-control",this.$el),function(b){var c=new a.BlockSelectionView({el:b});c.bind("open-selection",d.showSelection)})},initializeVideo:function(){e(".block-video").fitVids()},initializeSlideShow:function(){e(".flexslider").flexslider({animation:"slide",pauseOnHover:!0,slideshow:!0,slideshowSpeed:2e3})},updateBlock:function(a,b){this.trigger("update-block",a,b)},displayMoveGrid:function(a,b,c){c(a,b),e("body").addClass("block-move")},saveMovedBlock:function(a,c,d){d(a,c),e("body").removeClass("block-move");var f=c.$getChildren(c.el,"item"),g=f.index(a),h=new b.Models.ContentBlock({uuid:a.data("block-id"),container:c.el.data("container-id"),index:g}),i=h.move();i.complete(b.Api.reloadPage)}}),a.EditorFormView=c.View.extend({el:"#block-input-wrapper",events:{submit:"submitForm","change div[data-behaviours~=field-live-update] input":"updateTextElement","keyup div[data-behaviours~=field-live-update] input":"updateTextElement"},initialize:function(){f.bindAll(this,"render"),f.bindAll(this,"updateBlock"),f.bindAll(this,"initSliders"),f.bindAll(this,"initRichTextEditor"),f.bindAll(this,"initLinkSelector"),this.model=new b.Models.BlockForm({}),this.model.on("sync",this.render),this.iframeModal=new a.FullscreenModal},updateBlock:function(a,b){switch(this.model.set("uuid",b.id),a){case"edit":this.editBlock(b);break;case"move":this.moveBlock(b);break;case"delete":this.deleteBlock(b)}},editBlock:function(){this.model.fetch()},moveBlock:function(){},deleteBlock:function(a){a.destroy({success:function(){b.Api.reloadPage()}})},submitForm:function(a){a.preventDefault();var c=e("form",this.$el),d=e("button[type=submit]",this.$el),g=new b.Models.ContentBlock({});return c.data("locked")?!1:(d.attr("disabled",!0),c.data("locked",!0),f.each(c.serializeArray(),function(a){g.set(a.name,a.value)}),g.set("code",d.val()),g.set("container",c.data("container-id")),g.set("uuid",c.data("block-id")),void g.save({},{type:"PUT"}).complete(function(){d.attr("disabled",!1),c.data("locked",!1)}).error(function(){this.trigger("error","An error occured trying to delete a block. Please try it again.")}).success(function(){b.Api.reloadPage()}))},updateTextElement:function(a){f.isEmpty(a)||a.preventDefault();var b=e(a.target),c=null,d=null;return!b||f.isEmpty(b.attr("id"))?!1:(c=b.attr("id").replace("id_",""),d=e("#block-"+this.model.id+"-"+c),void d.html(b.val()))},render:function(){var c=this;this.$el.html(this.model.get("form")),this.initSliders(),this.initRichTextEditor(),this.initLinkSelector(),e(".fp-scroll-content").jScrollPane(),f.each(e(".fp-asset-input",this.$el),function(d){var f=new b.Models.AssetInputModel({id:e("[name=image_asset]",d).val(),type:e("[name=image_asset_type]",d).val(),image:e("img",d).attr("src")}),g=new a.AssetInputView({el:d,model:f});g.bind("select-image-clicked",c.iframeModal.showModal),c.iframeModal.bind("image-asset-updated",g.setSelectedAsset)})},initSliders:function(){var b=this;f.each(e("[type=range]"),function(c){var d=new a.Slider({el:c,block:b.model});d.render()})},initRichTextEditor:function(){var b=this;f.each(e(".rte-wrapper",this.$el),function(c){new a.RichTextEditor({el:c,block:b.model})})},initLinkSelector:function(){f.each(e("[data-behaviours=load-link-selector]",this.$el),function(b){new a.LinkSelector({el:b})})}}),a.BlockSelectionView=d.View.extend({events:{click:"openBlockSelection"},openBlockSelection:function(){this.trigger("open-selection",e("a",this.$el).data("container-id"))}}),a.BlockTypeView=d.View.extend({el:"#block_selection_modal",events:{"click button":"createBlock"},initialize:function(){f.bindAll(this,"showSelection")},createBlock:function(a){var c=e(a.target).closest("button"),d=this,f=new b.Models.ContentBlock({code:c.data("block-code"),container:this.containerId}),g=f.save({},{url:c.data("api-url")});g.complete(function(){d.$el.modal("hide"),b.Api.reloadPage()})},showSelection:function(a){this.containerId=a,this.$el.modal("show")}}),a.AssetInputView=d.View.extend({events:{"click a":"selectAsset"},initialize:function(){f.bindAll(this,"selectAsset"),f.bindAll(this,"setSelectedAsset"),this.modal=null},selectAsset:function(){var a=e("a",this.$el);this.$el.addClass("editing"),this.origin=a.data("input-name"),this.trigger("select-image-clicked",a.data("heading"),a.data("iframe-src"),this.origin)},setSelectedAsset:function(a,b,c,d){return this.$el.removeClass("editing"),d!==this.origin?!1:(e("input[name="+this.origin+"]",this.$el).attr("value",b),e("input[name="+this.origin+"_type]",this.$el).attr("value",a),void e("img",this.$el).attr("src",c))}}),a.Slider=d.View.extend({initialize:function(a){f.bindAll(this,"updateLayout"),this.block=a.block,this.min=parseInt(this.$el.attr("min")),this.max=parseInt(this.$el.attr("max"))},render:function(){this.$el.rangeslider({polyfill:!1,onSlide:this.updateLayout})},updateLayout:function(a,b){var c=e("#block-"+this.block.id),d=e(".column-left",c),g=e(".column-right",c);return f.isEmpty(d)||f.isEmpty(g)?!1:(d[0].className=d[0].className.replace(/span\d+/g,""),d.addClass("span"+b),g[0].className=g[0].className.replace(/span\d+/g,""),void g.addClass("span"+(this.max-b)))}}),a.FullscreenModal=d.View.extend({el:"#fullscreen-modal",initialize:function(){f.bindAll(this,"showModal"),f.bindAll(this,"hideModal"),f.bindAll(this,"triggerAssetUpdatedEvent"),this.origin=null,this.$iframe=null,this.template=f.template(e("#fullscreen-modal-template").html()||""),this.iframeTemplate=f.template("<iframe frameborder='0' width='99%' height='360'></iframe>"),this.on("image-asset-updated",this.hideModal)},showModal:function(a,b,c){var d=this;this.origin=c,this.$el.html(this.template({heading:a,bodyHtml:this.iframeTemplate()})),this.$el.modal("show"),this.iframe=e("iframe",this.el$),this.iframe.attr("src",b),this.iframe.load(function(){d.iframe.contents().on("click","[data-behaviours~=selectable-asset]",d.triggerAssetUpdatedEvent)})},hideModal:function(){this.iframe=null,this.$el.modal("hide")},triggerAssetUpdatedEvent:function(a){a.preventDefault();var b=e(a.currentTarget),c=b.data("asset-type"),d=b.data("asset-id"),f=e("img",b).attr("src");this.trigger("image-asset-updated",c,d,f,this.origin),this.origin=null}}),a.TabbedBlock=d.View.extend({events:{"click a.fp-add-tab":"addTab","click i.fp-delete-tab":"deleteTab"},initialize:function(){f.bindAll(this,"addTab"),this.collection=new b.Models.OrderedContainers,this.collection.bind("sync",b.Api.reloadPage)},addTab:function(){this.collection.create({block:this.model.id,language_code:this.model.get("languageCode")},{url:this.collection.url})},deleteTab:function(a){a.preventDefault();var c=new b.Models.OrderedContainer({uuid:e(a.target).data("block-id")});c.destroy().success(b.Api.reloadPage)}}),a.LinkSelector=d.View.extend({events:{click:"loadLinks"},initialize:function(){f.bindAll(this,"loadLinks"),f.bindAll(this,"setValue"),f.bindAll(this,"render"),this.heading=this.$el.data("heading"),this.template=f.template(e("#fullscreen-modal-template").html()||""),this.model=new b.Models.PageLinkForm({fieldId:this.$el.data("field-id")}),this.model.bind("sync",this.render)},loadLinks:function(){this.model.fetch()},setValue:function(a){a.preventDefault(),this.$el.siblings("input").val(e(a.target).attr("href"))},render:function(){var a=e("#fullscreen-modal");a.html(this.template({heading:this.heading,bodyHtml:this.model.get("rendered_form")})).modal("show"),e("a",a).bind("click",this.setValue)}});new a.EditorFormView});